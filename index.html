<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json"/>
  <base href="/barcode/">

  
  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon" href="GBP.LOGO.png">

  <!-- PWA æ”¯æ´å…ƒæ¨™ç±¤ -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="æ™ºèƒ½æ¢ç¢¼">


  <title>æ™ºèƒ½æ¢ç¢¼</title>
  
  <!-- ç¶²ç«™ favicon -->
  <link rel="icon" href="GBP.LOGO.png" type="image/x-icon">
  
  <!-- å¼•ç”¨å¤–éƒ¨ CSS æ–‡ä»¶ -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <button id="backToTop" style="display:none;">â†‘ Top â†‘</button>
  <div class="header">
    <h1><img src="GBP.LOGO.png" width="25" height="25">æ™ºèƒ½æ¢ç¢¼</h1>
    <input type="text" id="search" placeholder="ğŸ”æœå°‹" oninput="filterItems()">
  </div>

  <div class="container" id="main-container"></div>

  <div class="container">  
        <!-- è¼¸å…¥æ¢ç¢¼æ•¸å€¼ -->
       <table>
        <tr>
           <th colspan="3">
            <div id="barcode">
              <svg></svg>
              <input type="text" id="barcodeInput" oninput="updateBarcode()" placeholder="è¼¸å…¥æ¢ç¢¼">
            </div>
           </th>
        </tr>
        <tr>
            <td colspan="3"><h2>éšœç¤™æ¯”ç‡è¨ˆç®—</h2></td>
        </tr>
        <tr>
            <th></th>
            <th style="font-weight:bold">å³è€³</th>
            <th style="font-weight:bold">å·¦è€³</th>
        </tr>
        <tr>
            <th>500Hz</th>
            <td><input type="text" id="rightEar_500Hz"></td>
            <td><input type="text" id="leftEar_500Hz"></td>
        </tr>
        <tr>
            <th>1K Hz</th>
            <td><input type="text" id="rightEar_1000Hz"></td>
            <td><input type="text" id="leftEar_1000Hz"></td>
        </tr>
        <tr>
            <th>2K Hz</th>
            <td><input type="text" id="rightEar_2000Hz"></td>
            <td><input type="text" id="leftEar_2000Hz"></td>
        </tr>
        <tr>
            <th>4K Hz</th>
            <td><input type="text" id="rightEar_4000Hz"></td>
            <td><input type="text" id="leftEar_4000Hz"></td>
        </tr>
        <tr>
            <td></td>
            <td><button onclick="calculatePTA()">è¨ˆç®—</button></td>
            <td><button onclick="clearInput()">æ¸…ç©º</button></td>
        </tr>
        <tr>
            <th style="font-weight:bold">å„ªè€³</th>
            <th colspan="2" id="betterEar" style="font-weight:bold"></th>
        </tr>
        <tr>
            <th>PTA(dB)</th>
            <th id="rightEar_PTA"></th>
            <th id="leftEar_PTA"></th>
        </tr>
        <tr>
            <th style="font-weight:bold">å–®è€³(%)</th>
            <th id="rightEar_HL"></th>
            <th id="leftEar_HL"></th>
        </tr>
        <tr>
            <th style="font-weight:bold">é›™è€³(%)</th>
            <th colspan="2" id="bilateral_HL"></th>
        </tr>
        <tr>
            <th style="font-weight:bold">â€»åƒè€ƒâ€»</th>
            <th colspan="2">
           PTA(dB)=(500Hz+1000Hz+2000Hz+4000Hz)/4<br>
           å–®è€³éšœç¤™æ¯”ç‡(%)=(PTA-25)*1.5%<br>
           é›™è€³éšœç¤™æ¯”ç‡(%)=(å„ªè€³éšœç¤™æ¯”ç‡%*5 + åŠ£è€³éšœç¤™æ¯”ç‡%*1)/6
            </th>
        </tr>
    </table>
  </div>
    <!-- ç¬¬å››å€å¡Šï¼šé…ä»¶ç›¤é» -->
    <div class="section">
      <h2>é…ä»¶ç›¤é»</h2>
      <input type="file" id="fileInput" accept=".xlsx, .xls">
      <button onclick="uploadFile()">ç”Ÿæˆæ¢ç¢¼</button>
      <div id="inventoryContainer"></div>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    function uploadFile() {
      const fileInput = document.getElementById('fileInput');
      const container = document.getElementById('inventoryContainer');
      container.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
      const file = fileInput.files[0];
      if (!file) return alert("è«‹é¸æ“‡æª”æ¡ˆï¼");

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        workbook.SheetNames.forEach(sheetName => {
          const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
          rows.slice(1).forEach(row => {
            const qrData = row[2] || ''; // æ¢ç¢¼ç·¨è™Ÿ
            const details = {
              partNumber: row[0] || 'æœªçŸ¥æ–™è™Ÿ',
              name: row[1] || 'æœªçŸ¥åç¨±',
              barcode: row[2] || 'æœªçŸ¥æ¢ç¢¼',
              quantity: row[3] || 'æœªçŸ¥æ•¸é‡',
            };

            // å‰µå»ºè¡Œ
            const rowDiv = document.createElement('div');
            rowDiv.className = 'item-row';

            // å‰µå»ºQR Codeåœ–ç‰‡
            const img = document.createElement('img');
            QRCode.toDataURL(qrData, function(err, url) {
              img.src = url || '';
            });

            // å‰µå»ºæ–‡å­—è©³æƒ…
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'item-details';
            detailsDiv.innerHTML = `
              <p><strong>æ–™è™Ÿï¼š</strong>${details.partNumber}</p>
              <p><strong>åç¨±ï¼š</strong>${details.name}</p>
              <p><strong>ç”¢å“æ¢ç¢¼ï¼š</strong>${details.barcode}</p>
              <p><strong>æ•¸é‡ï¼š</strong>${details.quantity}</p>
            `;

            // å°‡åœ–ç‰‡å’Œæ–‡å­—åŠ å…¥è¡Œ
            rowDiv.appendChild(img);
            rowDiv.appendChild(detailsDiv);

            // åŠ å…¥åˆ°å®¹å™¨
            container.appendChild(rowDiv);
          });
        });
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
    <!-- å¼•ç”¨å¤–éƒ¨ JavaScript æ–‡ä»¶ -->
    <script src="category.js"></script>

    <!-- è¼‰å…¥ JsBarcode åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.0/JsBarcode.all.min.js"></script>
    <script>
        // æ›´æ–°æ¢ç¢¼
        function updateBarcode() {
            // ç²å–æ¢ç¢¼è¼¸å…¥æ¡†ä¸­çš„æ•¸å€¼
            var barcodeValue = document.getElementById("barcodeInput").value;
            // ä½¿ç”¨ JsBarcode ç”Ÿæˆæ¢ç¢¼
            JsBarcode("#barcode svg", barcodeValue, {
                format: "CODE128",
                displayValue: true,
                font: "Arial",
                textAlign: "center",
                textPosition: "bottom",
                textMargin: 10
            });
        }

        // åˆå§‹ç”Ÿæˆæ¢ç¢¼
        updateBarcode();

        function calculatePTA() {
            // ç²å–å³è€³å’Œå·¦è€³çš„æ•¸å€¼
            var rightEarData = [
                parseFloat(document.getElementById("rightEar_500Hz").value),
                parseFloat(document.getElementById("rightEar_1000Hz").value),
                parseFloat(document.getElementById("rightEar_2000Hz").value),
                parseFloat(document.getElementById("rightEar_4000Hz").value)
            ];

            var leftEarData = [
                parseFloat(document.getElementById("leftEar_500Hz").value),
                parseFloat(document.getElementById("leftEar_1000Hz").value),
                parseFloat(document.getElementById("leftEar_2000Hz").value),
                parseFloat(document.getElementById("leftEar_4000Hz").value)
            ];

            // è¨ˆç®—å¹³å‡å€¼
            var rightEarPTA = calculateAverage(rightEarData);
            var leftEarPTA = calculateAverage(leftEarData);

            // è¨ˆç®—å–®è€³è½éšœæ¯”ç‡
            var rightEarHearingLoss = 0;
            var leftEarHearingLoss = 0;

            if (rightEarPTA < 25) {
                rightEarHearingLoss = 0;
            } else {
                rightEarHearingLoss = ((rightEarPTA - 25) * 150) / 100;
            }

            if (leftEarPTA < 25) {
                leftEarHearingLoss = 0;
            } else {
                leftEarHearingLoss = ((leftEarPTA - 25) * 150) / 100;
            }

            // è¨ˆç®—å„ªè€³
            var betterEar = "";

            if (rightEarHearingLoss < leftEarHearingLoss) {
                betterEar = "å³è€³";
            } else if (leftEarHearingLoss < rightEarHearingLoss) {
                betterEar = "å·¦è€³";
            } else {
                betterEar = "";
            }

            // è¨ˆç®—é›™è€³è½éšœæ¯”ç‡
            var bilateralHearingLoss = 0;
            if (rightEarHearingLoss > leftEarHearingLoss && leftEarHearingLoss > 0) {
                bilateralHearingLoss = ((rightEarHearingLoss * 1) + (leftEarHearingLoss * 5)) / 6;
            } else if (leftEarHearingLoss > rightEarHearingLoss && rightEarHearingLoss > 0) {
                bilateralHearingLoss = ((rightEarHearingLoss * 5) + (leftEarHearingLoss * 1)) / 6;
            }

            // é¡¯ç¤ºçµæœ
            document.getElementById("rightEar_PTA").innerHTML = rightEarPTA.toFixed(1);
            document.getElementById("leftEar_PTA").innerHTML = leftEarPTA.toFixed(1);
            document.getElementById("rightEar_HL").innerHTML = rightEarHearingLoss.toFixed(1) + "%";
            document.getElementById("leftEar_HL").innerHTML = leftEarHearingLoss.toFixed(1) + "%";
            document.getElementById("bilateral_HL").innerHTML =  bilateralHearingLoss.toFixed(1) + "%";

            // æ ¹æ“šå„ªè€³å€¼æ‡‰ç”¨ä¸åŒçš„CSSæ¨£å¼
            if (betterEar === "å·¦è€³") {
                document.getElementById("betterEar").className = "blue-text";
            } else if (betterEar === "å³è€³") {
                document.getElementById("betterEar").className = "red-text";
            } else {
                // å¦‚æœå„ªè€³ç‚ºç©ºï¼Œæ¸…é™¤æ‰€æœ‰æ¨£å¼
                document.getElementById("betterEar").className = "";
            }

            // è¨­ç½®å„ªè€³å…§å®¹
            document.getElementById("betterEar").innerHTML = betterEar;
        }

        function calculateAverage(data) {
            var sum = 0;
            var count = 0;
            for (var i = 0; i < data.length; i++) {
                if (!isNaN(data[i])) {
                    sum += data[i];
                    count++;
                }
            }
            if (count > 0) {
                return sum / count;
            } else {
                return 0;
            }
        }

        // JavaScriptå‡½æ•°ï¼Œç”¨äºæ¸…ç©ºè¾“å…¥æ¡†çš„å€¼
        function clearInput() {
            var inputElements = document.getElementsByTagName("input");
            for (var i = 0; i < inputElements.length; i++) {
                inputElements[i].value = "";
            }
        }
    </script>

  <script>
    // ç²å–æŒ‰éˆ•å…ƒç´ 
    const backToTopButton = document.getElementById('backToTop');

    // æ»¾å‹•äº‹ä»¶ï¼šæ§åˆ¶æŒ‰éˆ•é¡¯ç¤º/éš±è—
    window.addEventListener('scroll', () => {
        if (window.scrollY > 200) {
            backToTopButton.style.display = 'block';
        } else {
            backToTopButton.style.display = 'none';
        }
    });

    // æŒ‰éˆ•é»æ“Šäº‹ä»¶ï¼šå›åˆ°é é¢é ‚éƒ¨
    backToTopButton.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth' // å¹³æ»‘æ»¾å‹•æ•ˆæœ
        });
    });
</script>
<script>

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/barcode/service-worker.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
            console.log('ServiceWorker registration failed: ', err);
        });
    });
}
</script>
</body>
</html>
