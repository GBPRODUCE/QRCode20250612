<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="manifest.json"/>
  <base href="/barcode/">

  
  <!-- Apple Touch Icon -->
  <link rel="apple-touch-icon" href="GBP.LOGO.png">

  <!-- PWA 支援元標籤 -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="智能條碼">


  <title>智能條碼</title>
  
  <!-- 網站 favicon -->
  <link rel="icon" href="GBP.LOGO.png" type="image/x-icon">
  
  <!-- 引用外部 CSS 文件 -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <button id="backToTop" style="display:none;">↑ Top ↑</button>
  <div class="header">
    <h1><img src="GBP.LOGO.png" width="25" height="25">智能條碼</h1>
    <input type="text" id="search" placeholder="🔍搜尋" oninput="filterItems()">
  </div>

  <div class="container" id="main-container"></div>

  <div class="container">  
        <!-- 輸入條碼數值 -->
       <table>
        <tr>
           <th colspan="3">
            <div id="barcode">
              <svg></svg>
              <input type="text" id="barcodeInput" oninput="updateBarcode()" placeholder="輸入條碼">
            </div>
           </th>
        </tr>
        <tr>
            <td colspan="3"><h2>障礙比率計算</h2></td>
        </tr>
        <tr>
            <th></th>
            <th style="font-weight:bold">右耳</th>
            <th style="font-weight:bold">左耳</th>
        </tr>
        <tr>
            <th>500Hz</th>
            <td><input type="text" id="rightEar_500Hz"></td>
            <td><input type="text" id="leftEar_500Hz"></td>
        </tr>
        <tr>
            <th>1K Hz</th>
            <td><input type="text" id="rightEar_1000Hz"></td>
            <td><input type="text" id="leftEar_1000Hz"></td>
        </tr>
        <tr>
            <th>2K Hz</th>
            <td><input type="text" id="rightEar_2000Hz"></td>
            <td><input type="text" id="leftEar_2000Hz"></td>
        </tr>
        <tr>
            <th>4K Hz</th>
            <td><input type="text" id="rightEar_4000Hz"></td>
            <td><input type="text" id="leftEar_4000Hz"></td>
        </tr>
        <tr>
            <td></td>
            <td><button onclick="calculatePTA()">計算</button></td>
            <td><button onclick="clearInput()">清空</button></td>
        </tr>
        <tr>
            <th style="font-weight:bold">優耳</th>
            <th colspan="2" id="betterEar" style="font-weight:bold"></th>
        </tr>
        <tr>
            <th>PTA(dB)</th>
            <th id="rightEar_PTA"></th>
            <th id="leftEar_PTA"></th>
        </tr>
        <tr>
            <th style="font-weight:bold">單耳(%)</th>
            <th id="rightEar_HL"></th>
            <th id="leftEar_HL"></th>
        </tr>
        <tr>
            <th style="font-weight:bold">雙耳(%)</th>
            <th colspan="2" id="bilateral_HL"></th>
        </tr>
        <tr>
            <th style="font-weight:bold">※參考※</th>
            <th colspan="2">
           PTA(dB)=(500Hz+1000Hz+2000Hz+4000Hz)/4<br>
           單耳障礙比率(%)=(PTA-25)*1.5%<br>
           雙耳障礙比率(%)=(優耳障礙比率%*5 + 劣耳障礙比率%*1)/6
            </th>
        </tr>
    </table>
  </div>
    <!-- 第四區塊：配件盤點 -->
    <div class="section">
      <h2>配件盤點</h2>
      <input type="file" id="fileInput" accept=".xlsx, .xls">
      <button onclick="uploadFile()">生成條碼</button>
      <div id="inventoryContainer"></div>
    </div>
  </div>

  <!-- JavaScript -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    function uploadFile() {
      const fileInput = document.getElementById('fileInput');
      const container = document.getElementById('inventoryContainer');
      container.innerHTML = ''; // 清空容器
      const file = fileInput.files[0];
      if (!file) return alert("請選擇檔案！");

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        workbook.SheetNames.forEach(sheetName => {
          const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
          rows.slice(1).forEach(row => {
            const qrData = row[2] || ''; // 條碼編號
            const details = {
              partNumber: row[0] || '未知料號',
              name: row[1] || '未知名稱',
              barcode: row[2] || '未知條碼',
              quantity: row[3] || '未知數量',
            };

            // 創建行
            const rowDiv = document.createElement('div');
            rowDiv.className = 'item-row';

            // 創建QR Code圖片
            const img = document.createElement('img');
            QRCode.toDataURL(qrData, function(err, url) {
              img.src = url || '';
            });

            // 創建文字詳情
            const detailsDiv = document.createElement('div');
            detailsDiv.className = 'item-details';
            detailsDiv.innerHTML = `
              <p><strong>料號：</strong>${details.partNumber}</p>
              <p><strong>名稱：</strong>${details.name}</p>
              <p><strong>產品條碼：</strong>${details.barcode}</p>
              <p><strong>數量：</strong>${details.quantity}</p>
            `;

            // 將圖片和文字加入行
            rowDiv.appendChild(img);
            rowDiv.appendChild(detailsDiv);

            // 加入到容器
            container.appendChild(rowDiv);
          });
        });
      };
      reader.readAsArrayBuffer(file);
    }
  </script>
    <!-- 引用外部 JavaScript 文件 -->
    <script src="category.js"></script>

    <!-- 載入 JsBarcode 庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.0/JsBarcode.all.min.js"></script>
    <script>
        // 更新條碼
        function updateBarcode() {
            // 獲取條碼輸入框中的數值
            var barcodeValue = document.getElementById("barcodeInput").value;
            // 使用 JsBarcode 生成條碼
            JsBarcode("#barcode svg", barcodeValue, {
                format: "CODE128",
                displayValue: true,
                font: "Arial",
                textAlign: "center",
                textPosition: "bottom",
                textMargin: 10
            });
        }

        // 初始生成條碼
        updateBarcode();

        function calculatePTA() {
            // 獲取右耳和左耳的數值
            var rightEarData = [
                parseFloat(document.getElementById("rightEar_500Hz").value),
                parseFloat(document.getElementById("rightEar_1000Hz").value),
                parseFloat(document.getElementById("rightEar_2000Hz").value),
                parseFloat(document.getElementById("rightEar_4000Hz").value)
            ];

            var leftEarData = [
                parseFloat(document.getElementById("leftEar_500Hz").value),
                parseFloat(document.getElementById("leftEar_1000Hz").value),
                parseFloat(document.getElementById("leftEar_2000Hz").value),
                parseFloat(document.getElementById("leftEar_4000Hz").value)
            ];

            // 計算平均值
            var rightEarPTA = calculateAverage(rightEarData);
            var leftEarPTA = calculateAverage(leftEarData);

            // 計算單耳聽障比率
            var rightEarHearingLoss = 0;
            var leftEarHearingLoss = 0;

            if (rightEarPTA < 25) {
                rightEarHearingLoss = 0;
            } else {
                rightEarHearingLoss = ((rightEarPTA - 25) * 150) / 100;
            }

            if (leftEarPTA < 25) {
                leftEarHearingLoss = 0;
            } else {
                leftEarHearingLoss = ((leftEarPTA - 25) * 150) / 100;
            }

            // 計算優耳
            var betterEar = "";

            if (rightEarHearingLoss < leftEarHearingLoss) {
                betterEar = "右耳";
            } else if (leftEarHearingLoss < rightEarHearingLoss) {
                betterEar = "左耳";
            } else {
                betterEar = "";
            }

            // 計算雙耳聽障比率
            var bilateralHearingLoss = 0;
            if (rightEarHearingLoss > leftEarHearingLoss && leftEarHearingLoss > 0) {
                bilateralHearingLoss = ((rightEarHearingLoss * 1) + (leftEarHearingLoss * 5)) / 6;
            } else if (leftEarHearingLoss > rightEarHearingLoss && rightEarHearingLoss > 0) {
                bilateralHearingLoss = ((rightEarHearingLoss * 5) + (leftEarHearingLoss * 1)) / 6;
            }

            // 顯示結果
            document.getElementById("rightEar_PTA").innerHTML = rightEarPTA.toFixed(1);
            document.getElementById("leftEar_PTA").innerHTML = leftEarPTA.toFixed(1);
            document.getElementById("rightEar_HL").innerHTML = rightEarHearingLoss.toFixed(1) + "%";
            document.getElementById("leftEar_HL").innerHTML = leftEarHearingLoss.toFixed(1) + "%";
            document.getElementById("bilateral_HL").innerHTML =  bilateralHearingLoss.toFixed(1) + "%";

            // 根據優耳值應用不同的CSS樣式
            if (betterEar === "左耳") {
                document.getElementById("betterEar").className = "blue-text";
            } else if (betterEar === "右耳") {
                document.getElementById("betterEar").className = "red-text";
            } else {
                // 如果優耳為空，清除所有樣式
                document.getElementById("betterEar").className = "";
            }

            // 設置優耳內容
            document.getElementById("betterEar").innerHTML = betterEar;
        }

        function calculateAverage(data) {
            var sum = 0;
            var count = 0;
            for (var i = 0; i < data.length; i++) {
                if (!isNaN(data[i])) {
                    sum += data[i];
                    count++;
                }
            }
            if (count > 0) {
                return sum / count;
            } else {
                return 0;
            }
        }

        // JavaScript函数，用于清空输入框的值
        function clearInput() {
            var inputElements = document.getElementsByTagName("input");
            for (var i = 0; i < inputElements.length; i++) {
                inputElements[i].value = "";
            }
        }
    </script>

  <script>
    // 獲取按鈕元素
    const backToTopButton = document.getElementById('backToTop');

    // 滾動事件：控制按鈕顯示/隱藏
    window.addEventListener('scroll', () => {
        if (window.scrollY > 200) {
            backToTopButton.style.display = 'block';
        } else {
            backToTopButton.style.display = 'none';
        }
    });

    // 按鈕點擊事件：回到頁面頂部
    backToTopButton.addEventListener('click', () => {
        window.scrollTo({
            top: 0,
            behavior: 'smooth' // 平滑滾動效果
        });
    });
</script>
<script>

if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/barcode/service-worker.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
            console.log('ServiceWorker registration failed: ', err);
        });
    });
}
</script>
</body>
</html>
